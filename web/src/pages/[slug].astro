---
import { client } from "../lib/sanity";
import groq from "groq";
import { PortableText } from "astro-portabletext";
import { urlFor } from "../lib/image";
import Layout from "../layouts/Layout.astro";

export const prerender = true;

const { slug } = Astro.params;

export async function getStaticPaths() {
  const raw = await client.fetch(
    groq`*[_type == "microsite" && defined(slug.current) && !(_id in path("drafts.**"))][].slug.current`
  );
  const only = import.meta.env.MICROSITE?.split(",").map(s => s.replace(/^\/+/, ""));
  const slugs = raw.map(s => s.replace(/^\/+/, ""));
  const filtered = only?.length ? slugs.filter(s => only.includes(s)) : slugs;
  return filtered.map(s => ({ params: { slug: s } }));
}
const data = await client.fetch(
  groq`*[_type == "microsite" 
        && slug.current in [$slug, "/" + $slug] 
        && !(_id in path("drafts.**"))][0]{
    title, description,
    hero{heading, subheading, image},
    sections[]{..., body},
    cta,
    seo{metaTitle, metaDescription, ogImage}
  }`,
  { slug }
);

if (!data) Astro.response.status = 404;

const og = data?.seo?.ogImage
  ? urlFor(data.seo.ogImage).width(1200).height(630).url()
  : undefined;
const pageTitle = data?.seo?.metaTitle ?? data?.title ?? "Not found";
const pageDesc = data?.seo?.metaDescription ?? data?.description ?? "";
---

<Layout title={pageTitle} description={pageDesc} ogImage={og}>
  {data ? (
    <>
      <header>
        <h1>{data.title}</h1>
        {data.hero?.subheading && <p>{data.hero.subheading}</p>}
        {data.hero?.image && (
          <img src={urlFor(data.hero.image).width(1600).url()} alt={data.title} />
        )}
      </header>

      {Array.isArray(data.sections) && data.sections.map((sec) => (
        <section>
          {sec.heading && <h2>{sec.heading}</h2>}
          {sec.body && <PortableText value={sec.body} />}
        </section>
      ))}

      {data.cta?.href && (
        <p><a href={data.cta.href}>{data.cta.label ?? "Learn more"}</a></p>
      )}
    </>
  ) : (
    <main>
      <h1>Not found</h1>
      <p>This microsite doesnâ€™t exist.</p>
    </main>
  )}
</Layout>
